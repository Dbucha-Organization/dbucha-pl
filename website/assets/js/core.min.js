(function(){"use strict";function P(){sessionStorage.setItem("_up_core_boosted","1")}var p=(t=>(t.LINKER_COMPLETED="_up_lk_cp",t.EXPOSE_ACTION_CONTEXT="__up_exposeActionContext",t.ESSENTIAL_WP_METRICS="__up_essentialMetrics",t))(p||{});const a={LINKER:"_upl",REDIRECT_URL:"redirect_url",REF_CODE:"sca_ref",SOURCE:"sca_source",SUB_ID1:"sub_id1",SUB_ID2:"sub_id2",SUB_ID3:"sub_id3",SUB_ID4:"sub_id4",SUB_ID5:"sub_id5"};function R(){if(new URLSearchParams(window.location.search).has(a.LINKER))return!0;if(!("__st"in window))return!1;try{return new URL("https://"+__st.pageurl).searchParams.has(a.LINKER)}catch{return!1}}function C(){return window.location.search!=""?new URL(window.location.href):"__st"in window?new URL("https://"+__st.pageurl):new URL(location.href)}function L(){const e=C().searchParams.get(a.REDIRECT_URL);e&&(window.location.href=atob(e))}function D(){if(!R())return;const t=C(),e=t.searchParams.get(a.REDIRECT_URL),n=t.searchParams.get(a.LINKER);if(!e||!n)return;const r=setInterval(()=>{if(document.readyState!="complete")return;const i=localStorage.getItem(p.LINKER_COMPLETED);i&&i===n&&(L(),clearInterval(r))},100);setTimeout(()=>{clearInterval(r)},1e4)}function b(){const t=UpPromoteCoreSettings.app_env.env,e={local:"https://secomapp-affiliate.test/js/storefront/uppromote-dev.js",test:"https://af-test.uppromote.com/js/storefront/uppromote-test.js",staging:"https://af-test.uppromote.com/js/storefront/uppromote-test.js",production:"https://d1639lhkj5l89m.cloudfront.net/js/storefront/uppromote.js"},n=e[t]||e.production,r=document.createElement("script");r.setAttribute("async","true"),r.src=n,document.body.prepend(r)}async function m(t,e){return(await fetch(window.Shopify.routes.root+t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).json()}function O(t,e){const n=o=>{const s=document.createElement("input");return s.type="hidden",s.name=o,s.value=e,s},r=o=>{o.appendChild(n(`attributes[${t}]`)),o.appendChild(n(`properties[${t}]`))},i=o=>{o.querySelector(`input[name="attributes[${t}]"]`)?.remove(),o.querySelector(`input[name="properties[${t}]"]`)?.remove()},c=(o,s,u)=>{s.setAttribute("disabled","disabled"),i(u),s.removeAttribute("disabled"),s.dispatchEvent(new Event("click")),setTimeout(()=>{r(u)},500)},l=document.querySelectorAll('form[action$="/cart/add"] button[type="submit"]');for(const o of Array.from(l)){const s=o.closest("form");s&&(r(s),o.addEventListener("mousedown",u=>c(u,o,s)),o.addEventListener("touchstart",u=>c(u,o,s)))}}async function S(t,e){const n=!!UpPromoteCoreSettings.currentCart.attributes[t],r=e!=UpPromoteCoreSettings.currentCart.attributes[t];(!n||r)&&await m("cart/update.js",{attributes:{[t]:e}}),O(t,e)}function I(t){UpPromoteCoreSettings.currentCart.attributes[t]&&m("cart/update.js",{attributes:{[t]:null}}).then()}function E(t){UpPromoteCoreSettings.currentCart.items.map((n,r)=>({index:r+1,hasProperty:!!n.properties[t]})).filter(n=>n.hasProperty).forEach(n=>{m("cart/change.js",{line:n.index,properties:{[t]:null}}).then()})}const h="_up_antiLeak";function v(){setTimeout(()=>{I(h),E(h)},1e3)}async function N(t){if(!t.useAntiLeak){v();return}const e=t.aid+"|"+t.pid;S(h,e).then()}let f=null;async function M(){return(await fetch("/cart.js")).json()}function j(){return f.discount_codes}async function T(t){await fetch("/cart/update.js",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({discount:t})})}async function B(t){j().some(r=>r.code===t)||await T(t)}async function F(t){if(f=await M(),!t){f.discount_codes&&f.discount_codes.length>0&&await T("");return}await B(t)}async function W(){UpPromoteCoreSettings.currentCart.attributes._up_apd&&await m("cart/update.js",{attributes:{_up_apd:null}});const t=UpPromoteCoreSettings.currentCart.items.map((e,n)=>({index:n+1,hasProperty:!!e.properties._up_apd})).filter(e=>e.hasProperty);for(const e of t)await m("cart/change.js",{line:e.index,properties:{_up_apd:null}})}function K(t){const e="_upWestdermAid";if(!t.af.tracked){I(e),E(e);return}S(e,String(t.af.id)).then()}async function k(t){t.cm_name=="westderm"&&K(t)}const x={applyDiscountCode:F,applyAntiLeak:N,cleanOldData:W,pingCustomize:k};function H(){try{const t=localStorage.getItem(p.EXPOSE_ACTION_CONTEXT);return t?JSON.parse(t):[]}catch{return[]}}function J(t){localStorage.setItem(p.EXPOSE_ACTION_CONTEXT,JSON.stringify(t))}async function w(){if(window.UpPromoteCoreSettings.communicating)return;window.UpPromoteCoreSettings.communicating=!0;const t=H();for(;t.length>0;){const e=t.shift();J(t);try{x[e.n]?.(e.d)}finally{}}window.UpPromoteCoreSettings.communicating=!1}var _=(t=>(t.SHOPIFY_DISCOUNT_CODE="discount_code",t.AFFILIATE_ID="up_uppromote_aid",t.AFFILIATE_HASH_CODE="up_uppromote_hs",t.SOURCE="up_uppromote_source",t.LAST_CLICK="up_uppromote_lc",t.RECEIVED="up_uppromote_received",t.SUB_ID="up_uppromote_sub_id",t.CLICK_ID="_up_cid",t))(_||{});function g(t){const e=`${encodeURIComponent(t)}=`,n=document.cookie.split(";");for(let r=0;r<n.length;r++){let i=n[r];for(;i.charAt(0)===" ";)i=i.substring(1,i.length);if(i.indexOf(e)===0)return decodeURIComponent(i.substring(e.length,i.length))}return null}const U=20;function $(){return crypto.randomUUID()}function y(){const t=localStorage.getItem(p.ESSENTIAL_WP_METRICS);return t?JSON.parse(t):[]}function X(t){const e=t.length;e>U&&(t=t.slice(e-U)),localStorage.setItem(p.ESSENTIAL_WP_METRICS,JSON.stringify(t))}function d(t,e,n=1){const r=$();let i=y();const c=i.filter(o=>o.n!=t),l=i.filter(o=>o.n==t).sort((o,s)=>s.t-o.t).filter((o,s)=>s+1<n);return i=[...c,...l].sort((o,s)=>o.t-s.t),i.push({i:r,n:t,d:e,t:new Date().getTime()}),X(i),r}function G(){localStorage.setItem(p.ESSENTIAL_WP_METRICS,JSON.stringify([]))}function q(t){return t.startsWith("http")?new URL(t).searchParams.has(a.REF_CODE):new URLSearchParams(t).has(a.REF_CODE)}function V(t){const e=t.startsWith("http")?new URL(t).searchParams:new URLSearchParams(t),[n,r]=e.get(a.REF_CODE)?.split(".")||[];return{affiliate_id:n,hash_code:r,shopify_domain:Shopify.shop,source:e.get(a.SOURCE)||null,sub_id1:e.get(a.SUB_ID1)||null,sub_id2:e.get(a.SUB_ID2)||null,sub_id3:e.get(a.SUB_ID3)||null,sub_id4:e.get(a.SUB_ID4)||null,sub_id5:e.get(a.SUB_ID5)||null}}function z(t,e,n=1){return Array(Math.ceil((e-t)/n)).fill(t).map((r,i)=>r+i*n).concat(e)}const Q={local:{TRACKING:"https://uppromote-tracking.test"},test:{TRACKING:"https://pixel-test.uppromote.com"},production:{TRACKING:"https://pixel.uppromote.com"}}[UpPromoteCoreSettings.app_env.env];function Y(){const t=UpPromoteCoreSettings.app_env.env;return{local:"12140609537",test:"46339948545",production:"2773553"}[t||"production"]}function Z(){const t=document.querySelector("script#web-pixels-manager-setup");if(!t){d("wp:load",!1,5);return}const e=t.textContent?.includes(Y());d("wp:load",e,5)}function tt(){if(!q(window.location.search))return;let t=!1;const e=performance.getEntriesByType("navigation")[0],n=new Date(performance.timeOrigin+e.startTime),r=V(window.location.search),i=o=>{const s=g(_.AFFILIATE_ID),u=g(_.RECEIVED);if(s==r.affiliate_id&&u=="1"){clearInterval(o);const ot=new Date().getTime()-n.getTime();d("wp:refPerformance",ot,5),d("wp:clickDuration",{load:n.getTime(),cid:g(_.CLICK_ID)},3),t=!0}},c=o=>{!t&&o&&(clearInterval(o),d("wp:refPerformance","WAIT_5_SECONDS_TIMEOUT",5))},l=setInterval(()=>i(l),100);setTimeout(()=>c(l),5e3)}function et(){const t=d("wp:ping",{pingAt:new Date().getTime()},5);Shopify.analytics.publish("uppromote:ping",{id:t})}function nt(){setTimeout(()=>{const e=y(),n=z(5,10),r=Math.floor(Math.random()*n.length);if(e.length>=n[r]){const i=e.map(c=>(delete c.i,delete c.t,c));fetch(`${Q.TRACKING}/api/metrics`,{method:"POST",body:JSON.stringify({shop:Shopify.shop,metrics:i}),headers:{"Content-Type":"application/json"}}).then(G)}},2e3)}function rt(){Z(),tt(),et(),nt()}function A(){w().then(),setInterval(w,300),P(),b(),D(),rt()}document.readyState!=="loading"?A():document.addEventListener("DOMContentLoaded",A)})();
